name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  lint:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint shellcheck zsh jq

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install yamllint shellcheck jq

      - name: Lint YAML files
        run: |
          yaml_files=$(find . -type f \( -name "*.yml" -o -name "*.yaml" \) -not -path "./.git/*")
          if [ -n "$yaml_files" ]; then
            echo "$yaml_files" | xargs yamllint
          else
            echo "No YAML files found"
          fi

      - name: Lint shell scripts
        run: |
          shell_files=$(find . -type f -name "*.sh" -not -path "./.git/*")
          if [ -n "$shell_files" ]; then
            echo "$shell_files" | xargs shellcheck
          else
            echo "No shell scripts found"
          fi

      - name: Check Zsh syntax
        run: |
          zsh_files=$(find . -type f -name "*.zsh" -not -path "./.git/*")
          if [ -n "$zsh_files" ]; then
            echo "$zsh_files" | xargs zsh -n
          else
            echo "No Zsh files found"
          fi

      - name: Validate JSON files
        run: |
          json_files=$(find . -type f \( -name "*.json" -o -name "*.jsonc" \) -not -path "./.git/*")
          if [ -n "$json_files" ]; then
            for file in $json_files; do
              echo "Validating $file"
              # For .jsonc files, remove comments before validation
              if [[ "$file" == *.jsonc ]]; then
                # Basic comment removal (not perfect but works for most cases)
                sed 's|//.*||g' "$file" | jq . > /dev/null
              else
                jq . "$file" > /dev/null
              fi
            done
          else
            echo "No JSON files found"
          fi
